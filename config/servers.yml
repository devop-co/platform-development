---
:ssh_config: &ssh_config
  :type: inline
  :vars:
    -
     :ssh_pub_key: <% = File.readlines("#{Dir.home}/.ssh/vagrant_id_rsa.pub").first.strip %>
  :script: |
    <<-SHELL
      echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys
    SHELL

:login_as_deploy: &login_as_deploy
  :type: inline
  :script: |
    <<-EOF
      if [ ! -f /home/vagrant/.login_as_deploy ] && id -u "deploy" >/dev/null 2>&1; then
        echo '
          setfacl -m deploy:x $(dirname "$SSH_AUTH_SOCK")
          setfacl -m deploy:rwx "$SSH_AUTH_SOCK"
          sudo -E su deploy
        ' > /home/vagrant/.login_as_deploy
        chown vagrant:vagrant /home/vagrant/.login_as_deploy
        echo "source .login_as_deploy" >> /home/vagrant/.bash_profile
      fi
    EOF

:puppet_install: &puppet_install
  :type: inline
  :script: |
    if which puppet > /dev/null 2>&1; then
      echo 'Puppet Installed.'
    else
      echo 'Puppet Installation Script' &&\
      grep -q 'rvm use system' /root/.bashrc || echo 'rvm use system 2>/dev/null' >> /root/.bashrc && \
      rpm ivh --replacepkgs --quiet http://yum.puppetlabs.com/puppetlabs-release-el-$( rpm -q --qf "%{VERSION}" $(rpm -q --whatprovides redhat-release ) ).noarch.rpm && \
      yum install -y -q puppet-3.8.7
    fi
:puppet: &puppet
  :type: puppet
  :puppet_facters:
    :organization: devop-co
    :client: devop-co
    :env: development
    :role: web
    :sub_role: db
    :puppet_environment: development
  :puppet_paths:
    :modules_dir: "../platform-puppet/modules"
    :manifests_path: "../platform-puppet/manifests"
    :manifest_file: "site.pp"
    :hiera_config_file: "../platform-configs/hiera.yaml"

:provisors: &provisors
  :provisioners:
    # -
    #   <<: *ssh_config
    -
      <<: *puppet_install
    -
      <<: *puppet
    -
      <<: *login_as_deploy
:vm_defaults: &vm_defaults
  :sync_rvm: true
  :sync_apps: false
  # :box: "devopco/centos-7-2-min"
  :box: "vitals/centos-6.6"
  :ram: 1024
  :cpus: 1
  :forward_agent: false
  :auto_nat_dns_proxy: false
  :natdnshostresolver1: "on"
  :natdnsproxy1: "on"
:servers:
  -
    <<: *vm_defaults
    :name: "web01"
    :hostname: "web01.devopco.lcl"
    <<: *provisors

# Example Configurations
  # -
  #   <<: *vm_defaults
  #   :name: "web02"
  #   :hostname: "web02.devopco.lcl"
  #   :ip: "192.168.0.11"
  #   :sync_apps: true
  #   :apps:
  #     - directory_name
  #   <<: *provisioners
